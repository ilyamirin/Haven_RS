# Haven RS — мультиагентный рекомендатель товаров

Haven is ready to dress you. 👔🧥👢

Проект — исполняемый мультиагентный рекомендатель одежды/товаров, построенный на LangGraph и Hugging Face Transformers. Он читает список агентов (их роли/личности) из `agents_list.csv`, каталог товаров из `data/27181_all_cards.csv`, принимает естественно-языковой запрос пользователя и выводит финальную рекомендацию товара. В процессе работы стримит «мысли» агентов в консоль (с цветовым оформлением, через rich).

## Что делает проект
- Принимает запрос пользователя на естественном языке (например: «Ищу теплую рубашку в клетку на осень»).
- Прогоняет запрос через цепочку экспертных агентов (их набор и порядок — в `agents_list.csv`).
- Каждый агент добавляет свой вклад: фильтрация, обоснование, уточнение, короткий шорт-лист товаров.
- Координатор (финальный агент) агрегирует предложения и выбирает один лучший товар.
- Показывает финальную рекомендацию с основными полями карточки товара.

Основные технологии:
- LangGraph — для описания и исполнения графа состояний между агентами.
- Hugging Face Transformers — для локального/онлайн запуска LLM (чат‑модели). Модель читается из переменной окружения `HF_MODEL` (дефолт в коде: `Qwen/Qwen-7B-Chat`).
- rich — «красивый» вывод мыслей агентов в консоль.

## Архитектура и взаимодействие агентов
Ниже — упрощённая схема графа (LangGraph). Узлы исполняются последовательно от подготовки до координатора.

```
┌──────────────────────────────────────────────────────────┐
│                      RecoState                           │
│  query, catalog, shortlist, messages, suggestions, final │
└──────────────────────────────────────────────────────────┘
             │
             ▼
┌──────────────────────────────┐
│ prepare                      │
│ - нормализация запроса       │
│ - токенизация                │
│ - первичный шорт-лист        │
└───────────────┬──────────────┘
                │
                ▼
      ┌──────────────────────┐
      │ Agent #1             │
      │ (из agents_list.csv) │
      └──────────┬───────────┘
                 │
                 ▼
      ┌──────────────────────┐
      │ Agent #2             │
      │ (из agents_list.csv) │
      └──────────┬───────────┘
                 │
                 ├── … (последовательно для всех агентов кроме координатора)
                 │
                 ▼
      ┌──────────────────────┐
      │ Coordinator          │
      │ (финальный агент)    │
      └──────────┬───────────┘
                 │ выбор 1 товара
                 ▼
              ┌───────┐
              │  END  │
              └───────┘
```

Логика выбора координатора:
- Если среди имён агентов есть «Wardrobe Agent», он считается координатором.
- Иначе координатором выступает последний агент в файле `agents_list.csv`.

Каждый агент получает текущий `RecoState` и генерирует свой ответ через LLM (если доступен), добавляя сообщение и/или уточняя шорт-лист. Координатор анализирует финальный шорт-лист и выбирает одну карточку.

## Файлы проекта
- `main.py` — основной исполняемый скрипт, сборка графа и логика запуска.
- `agents_list.csv` — список агентов с ролями/личностями. Последний — координатор (если нет явного «Wardrobe Agent»).
- `data/27181_all_cards.csv` — каталог товаров (как правило, TSV: таб‑разделители). Поля: `name`, `brand`, `category`, `color/colors`, `mark`, `keyword`, `kinds`, `description`, …
- `requirements.txt` — зависимости Python.

## Требования
- Python 3.10+ (рекомендуется 3.10/3.11).
- Интернет-соединение (если модель не закеширована локально).
- Для ускорения — GPU с поддержкой CUDA (не обязательно). Без GPU модель тоже запустится (медленнее).

## Установка
1) Клонируйте проект и перейдите в каталог проекта.
2) Установите зависимости:
- Windows (PowerShell):
  ```powershell
  python -m venv .venv
  .\.venv\Scripts\Activate.ps1
  pip install -r requirements.txt
  ```
- Linux/macOS (bash):
  ```bash
  python -m venv .venv
  source .venv/bin/activate
  pip install -r requirements.txt
  ```

## Настройка модели (HF_MODEL)
По умолчанию в коде используется модель:
- `Qwen/Qwen-7B-Chat`

Можно переопределить через переменную окружения `HF_MODEL`, например:
- Windows (PowerShell):
  ```powershell
  $env:HF_MODEL = "Qwen/Qwen2.5-3B-Instruct"
  ```
- Linux/macOS (bash):
  ```bash
  export HF_MODEL="Qwen/Qwen2.5-3B-Instruct"
  ```

Загрузка выполняется с приоритетом локального кэша. Если модель отсутствует — будет скачана с Hugging Face (это может занять время и место на диске).

Советы:
- На CPU выбирайте меньшие модели (2–4B), чтобы ускорить генерацию.
- На GPU можно оставить «7B» или больше (если хватает VRAM).

## Формат agents_list.csv
Поддерживаются два варианта:

1) Новый (с заголовками, RU/EN допускаются, разделитель: `,`, `;` или `\t`):
```
Агент,Роль,Личность,Tooling,Промпт
Color Expert,"Подбирает палитру","Вежливый, аккуратный",no,"Краткая инструкция для color-эксперта"
Style Expert,"Рекомендует стили","Дерзкий, уверенный",no,"Как формировать образы и на что смотреть"
Wardrobe Agent,"Координатор","Собирает мнения и выбирает итог",no,"Правила выбора финальной рекомендации"
```
Ключевые заголовки (кейсы и пробелы не критичны): Агент/Agent/Name, Роль/Role, Личность/Persona, Поддержка tooling?/Tooling/Supports tooling, Промпт/Prompt/Instruction/System.

- Колонка «Промпт/Prompt» опциональна. Если задана — её текст автоматически подмешивается к системному промпту соответствующего агента (и координатора), усиливая его поведение.

2) Легаси (без заголовка, 3 колонки):
```
Color Expert,подбор цвета,коллаборативный
Style Expert,стили,уверенный
Wardrobe Agent,координатор,спокойный
```
В обоих случаях координатор — «Wardrobe Agent», если его имя встречается в списке (включая описательные дополнения в скобках). Иначе координатором становится первый агент списка.

## Формат data/27181_all_cards.csv
Как правило, TSV (таб‑разделители). Важные поля, которые показываются в финальной таблице:
- `name`, `brand`, `category`, `color`/`colors`, `mark`, `keyword`, `kinds`, `description`.

## Запуск
- Быстрый старт (будет задан вопрос в консоли):
  ```powershell
  python main.py
  ```
- С указанием запроса в командной строке:
  ```powershell
  python main.py --query "Ищу теплую рубашку в клетку на осень"
  ```
- С явным указанием модели:
  ```powershell
  $env:HF_MODEL = "Qwen/Qwen2.5-3B-Instruct"
  python main.py --query "Ищу куртку на межсезонье"
  ```

В начале выполнения вы увидите баннер, слоган и информацию о модели. Затем — поток сообщений агентов и финальную таблицу с рекомендованным товаром.

## Пример (ожидаемый) вывода
```
─────────────────────────────────────────────────────────────
Мультиагентная рекомендация (LangGraph + Transformers)
Haven is ready to dress you. 👔🧥👢
Модель: Qwen/Qwen-7B-Chat
Запрос пользователя: Ищу теплую рубашку в клетку на осень

[Color Expert] …
[Style Expert] …
[Coordinator] …
─────────────────────────────────────────────────────────────
Рекомендация координатора
┏━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Поле       ┃ Значение                                     ┃
┡━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ name       │ …                                            │
│ brand      │ …                                            │
│ category   │ …                                            │
│ color      │ …                                            │
│ mark       │ …                                            │
│ keyword    │ …                                            │
│ kinds      │ …                                            │
│ description│ …                                            │
└────────────┴──────────────────────────────────────────────┘
```

## Типичные проблемы и решения
- «Модель не найдена в локальном кэше…» — это нормально: будет скачана с Hugging Face. Убедитесь, что есть интернет и достаточно свободного места на диске.
- «LLM недоступен» — проверьте, что установлены зависимости (`pip install -r requirements.txt`) и корректно задана переменная `HF_MODEL`.
- Медленная генерация — попробуйте меньшую модель (например, 3B) или используйте GPU с `device_map="auto"` (настраивается автоматически, если CUDA доступна).
- Формат `agents_list.csv` — проверьте наличие заголовков в новом формате либо ровно 3 колонки в легаси.
- Координатор — если нет «Wardrobe Agent», последняя строка файла станет координатором.

## Лицензия и вклад
Если у вас есть предложения по улучшению агентов или архитектуры, создавайте issues/PR. Лицензия — по договорённости владельца репозитория (не указана в исходниках).
